# TODO: deprecate axon-start-with-short-genesis.yml
name: Start Single Axon Node

on:
  push:
  pull_request:
  merge_group:
  workflow_dispatch:

jobs:
  build-and-run:
    strategy:
      matrix:
        # Supported GitHub-hosted runners and hardware resources
        # see https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners#supported-runners-and-hardware-resources
        os: [ubuntu-20.04, ubuntu-22.04] # TODO: test on [windows-latest, macos-latest]
      fail-fast: false
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v3

      - name: Cache of the axon binary
        id: axon-bin-cache
        uses: actions/cache@v3
        with:
          path: |
            target/debug/axon
            target/release/axon
          key: ${{ matrix.os }}-${{ runner.os }}-${{ runner.arch }}-axon-${{ github.sha }}

      - name: Cargo Cache
        if: steps.axon-bin-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ matrix.os }}-${{ runner.os }}-${{ runner.arch }}-cargo-${{ github.sha }}
          restore-keys: |
            ${{ matrix.os }}-${{ runner.os }}-${{ runner.arch }}-cargo-

      - name: Cache Axon target directory
        if: steps.axon-bin-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v3
        with:
          path: |
            target
          key: ${{ matrix.os }}-${{ runner.os }}-${{ runner.arch }}-cargo-target-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ matrix.os }}-${{ runner.os }}-${{ runner.arch }}-cargo-target
      
      - name: Install Rust components
        if: steps.axon-bin-cache.outputs.cache-hit != 'true'
        run: rustup component add rustfmt && rustup component add clippy

      - name: Build Axon
        if: steps.axon-bin-cache.outputs.cache-hit != 'true'
        run: cargo build

      - name: Start a single Axon node
        run: |
          target/debug/axon --version
          target/debug/axon run \
            -c devtools/chain/config.toml \
            -g devtools/chain/genesis_single_node.json \
            > /tmp/single-axon-node.log &
         
          sleep 300
          set +e
          result=$(tail -n 100 /tmp/single-axon-node.log | grep 'state goto new height 100')

          if [[ "$result" != "" ]]
          then
              echo "axon chain works well"
          else
              echo "axon chain has some issues, please have a check"
              exit 1
          fi

      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: axon-single-node-logs
          path: |
            /tmp/single-axon-node.log
